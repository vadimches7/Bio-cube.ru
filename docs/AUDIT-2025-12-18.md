# Bio-Cube.ru — аудит качества и стабильности (18.12.2025)

## Что проверено

### Автоматические проверки

- `tsc --noEmit` — **OK**
- `npm run build` — **OK**
- `npm run lint` — **OK** (без warnings после настройки overrides)

### Ручной обзор

- Структура проекта и документации (`README.md`, `docs/*`)
- Отправка лидов (клиент → Supabase Edge Function → webhook)
- Роутинг и “заглушки” юридических страниц
- Потенциальные места падений из‑за env

---

## Исправления, внесённые в ходе аудита

### P0 — линтер падал из-за `any`

- Убраны `any` и добавлена безопасная типизация:
  - `src/lib/submitLead.ts` (ответ `supabase.functions.invoke`)
  - `supabase/functions/lead-webhook/index.ts` (парсинг `req.json()` через `unknown` + safe-cast)

### P0 — дублирующий helper отправки + риск утечки ключей

- Удалён `src/lib/submitLeadV2.ts`
- `ContactFormDialog` переведён на единый helper: `src/lib/submitLead.ts`

### P0 — отсутствие шаблона env и “неочевидные падения”

- Добавлен `env.example` (из-за ограничений окружения файл `.env.example` создать нельзя)
- `README.md` обновлён: какие переменные нужны и как настраивать webhook корректно
- В `src/integrations/supabase/client.ts` добавлен fail-fast:
  - если `VITE_SUPABASE_URL` / `VITE_SUPABASE_PUBLISHABLE_KEY` не заданы — будет понятная ошибка с инструкцией

### P1 — server-side anti-abuse на Edge Function

В `supabase/functions/lead-webhook/index.ts` присутствуют и используются:

- ограничение размера payload (best-effort по `content-length`)
- allowlist по Origin через секрет `ALLOWED_ORIGINS` (опционально)
- in-memory rate limit (best-effort, на инстанс функции)
- backend honeypot по полю `website`

### P2 — сборка без “>500kB chunk” предупреждений

- Настроен `build.rollupOptions.output.manualChunks` в `vite.config.ts`
- Итог: bundle режется на чанки `react/router/radix/supabase/...`

### P2 — шумные warnings react-refresh

- В `eslint.config.js` добавлены overrides, чтобы не ругаться на shadcn/ui файлы и контекст, где экспортируются helper’ы вместе с компонентами.

---

## Риски / что важно закрыть перед продом

### P1 — защита от спама (усилить при необходимости)

Текущий rate limit в Edge Function — **best-effort** (память на инстанс). Для рекламного трафика лучше:

- добавить более строгий лимит (например по IP + телефону после парсинга)
- добавить captcha/hCaptcha на форме (или серверную проверку token)
- логировать 429/403 в отдельный канал

### P1 — юридические страницы

`/privacy` и `/offer` — **заглушки**. Перед запуском рекламы заменить на юридически корректные тексты.

### P2 — env/секреты Supabase

Рекомендуемая настройка:

- В `.env` (локально, клиент):
  - `VITE_SUPABASE_URL`
  - `VITE_SUPABASE_PUBLISHABLE_KEY`
- В Supabase Secrets (Functions):
  - `ALBATO_WEBHOOK_URL` — URL Albato webhook (не должен попадать в клиент)
  - `ALLOWED_ORIGINS` — список origin через запятую (опционально)

---

## Чеклист “готово к прод”

- [ ] Заполнен `.env` на локалке (по `env.example`)
- [ ] В Supabase Secrets заданы `ALBATO_WEBHOOK_URL` (+ при необходимости `ALLOWED_ORIGINS`)
- [ ] Юр. страницы `/privacy` и `/offer` заменены на финальные тексты
- [ ] Проверена отправка формы в реальный webhook (и обработка ошибок)
- [ ] Проверен режим `?mode=service|installation` и смена контента/CTA


